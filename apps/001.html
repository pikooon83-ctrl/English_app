<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>1åˆ†ã‚¹ãƒ”ãƒ¼ãƒç·´ç¿’ã‚¿ã‚¤ãƒãƒ¼ï¼ˆéŒ²éŸ³ãƒ»4ã‚³ãƒãƒ»èª­ã¿ä¸Šã’ã¤ãï¼‰</title>
  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background: #f7f8fb;
      color: #222;
      line-height: 1.5;
    }
    .wrap {
      max-width: 760px;
      margin: 0 auto;
      padding: 16px;
    }
    .card {
      background: #fff;
      border-radius: 16px;
      padding: 16px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.06);
      margin-bottom: 16px;
    }
    h1 {
      font-size: 22px;
      margin: 0 0 8px;
    }
    .sub {
      color: #666;
      font-size: 14px;
      margin-bottom: 12px;
    }
    .time {
      font-size: 56px;
      font-weight: 700;
      text-align: center;
      letter-spacing: 1px;
      margin: 8px 0 12px;
    }
    .status {
      text-align: center;
      font-size: 14px;
      color: #555;
      min-height: 1.4em;
      margin-bottom: 12px;
    }
    .grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0,1fr));
      gap: 10px;
    }
    button {
      width: 100%;
      padding: 14px 12px;
      border: none;
      border-radius: 12px;
      font-size: 16px;
      font-weight: 600;
      background: #e9edf5;
      color: #222;
      cursor: pointer;
      -webkit-tap-highlight-color: transparent;
    }
    button:disabled {
      opacity: 0.55;
      cursor: not-allowed;
    }
    button:active {
      transform: scale(0.99);
    }
    .primary { background: #1f6feb; color: #fff; }
    .danger  { background: #e5484d; color: #fff; }
    .muted   { background: #eef1f6; color: #444; }
    .record  { background: #d92d20; color: #fff; }
    .recording {
      box-shadow: 0 0 0 4px rgba(217,45,32,0.18) inset;
    }

    .sentence {
      font-size: 20px;
      font-weight: 600;
      margin: 8px 0 6px;
    }
    .translation {
      color: #666;
      font-size: 14px;
      margin-bottom: 8px;
    }
    .small {
      font-size: 13px;
      color: #666;
    }
    .audio-wrap {
      margin-top: 10px;
    }
    audio {
      width: 100%;
      margin-top: 8px;
    }

    .comic-box {
      margin-top: 10px;
    }
    .comic-image {
      width: 100%;
      display: block;
      border-radius: 12px;
      background: #f2f4f8;
      border: 1px solid #eef1f6;
    }
    .hidden-placeholder {
      display: none;
      width: 100%;
      min-height: 180px;
      border-radius: 12px;
      background: #f3f5fa;
      border: 1px dashed #cfd6e4;
      color: #667085;
      align-items: center;
      justify-content: center;
      text-align: center;
      padding: 16px;
      font-size: 14px;
    }

    select {
      width: 100%;
      padding: 10px;
      border-radius: 10px;
      border: 1px solid #d8deea;
      background: #fff;
      font-size: 14px;
    }

    @media (min-width: 680px) {
      .grid {
        grid-template-columns: repeat(3, minmax(0,1fr));
      }
      .time { font-size: 68px; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>â± 1åˆ†ã‚¹ãƒ”ãƒ¼ãƒç·´ç¿’ã‚¿ã‚¤ãƒãƒ¼ï¼ˆéŒ²éŸ³ãƒ»4ã‚³ãƒãƒ»èª­ã¿ä¸Šã’ã¤ãï¼‰</h1>
      <div class="sub">4ã‚³ãƒã‚’è¦‹ã¦è©±ã™ â†’ éŒ²éŸ³ â†’ è‹±æ–‡ç¢ºèª â†’ ãŠæ‰‹æœ¬èª­ã¿ä¸Šã’ã§å¾©ç¿’</div>

      <div id="timeDisplay" class="time">01:00</div>
      <div id="status" class="status">æº–å‚™OK</div>

      <div class="grid">
        <button id="startBtn" class="primary">â–¶ é–‹å§‹</button>
        <button id="pauseBtn" class="muted">â¸ ä¸€æ™‚åœæ­¢</button>
        <button id="resetBtn" class="danger">â†º ãƒªã‚»ãƒƒãƒˆ</button>
        <button id="minusBtn" class="muted">âˆ’10ç§’</button>
        <button id="plusBtn" class="muted">ï¼‹10ç§’</button>
        <button id="shuffleBtn" class="muted">ğŸ”€ æ–‡ã‚’ã‚·ãƒ£ãƒƒãƒ•ãƒ«</button>
      </div>

      <p class="small" style="margin-top:10px;">
        ä½¿ã„æ–¹ï¼š4ã‚³ãƒã‚’è¦‹ã‚‹ â†’ è‹±æ–‡ã‚’éš ã™ â†’ é–‹å§‹ â†’ 1åˆ†è©±ã™ â†’ éŒ²éŸ³ã‚’èã â†’ è‹±æ–‡ã§ç­”ãˆåˆã‚ã› â†’ ãŠæ‰‹æœ¬ã‚’èã
      </p>
    </div>

    <div class="card">
      <h1 style="font-size:20px; margin-bottom:6px;">ğŸ–¼ 4ã‚³ãƒï¼ˆã‚¤ãƒ¡ãƒ¼ã‚¸ç·´ç¿’ï¼‰</h1>
      <div class="small">å…ˆã«çµµã ã‘è¦‹ã¦è‹±èªã§èª¬æ˜ã—ã¦ã¿ã‚ˆã†</div>

      <div class="comic-box">
        <img id="comicImage"
             class="comic-image"
             src="001.PNG"
             alt="æœã®ãƒã‚¿ãƒã‚¿ 4ã‚³ãƒ">
        <div id="comicHiddenPlaceholder" class="hidden-placeholder">
          4ã‚³ãƒã¯éè¡¨ç¤ºã§ã™<br>ã€ŒğŸ‘€ 4ã‚³ãƒã‚’è¡¨ç¤ºã€ã‚’æŠ¼ã—ã¦ã­
        </div>
      </div>

      <div class="grid" style="margin-top:10px;">
        <button id="toggleComicBtn" class="muted">ğŸ™ˆ 4ã‚³ãƒã‚’éš ã™</button>
        <button id="toggleTextBtn" class="muted">ğŸ“ è‹±æ–‡/å’Œè¨³ã‚’éš ã™</button>
      </div>
    </div>

    <div class="card">
      <div class="small" id="indexLabel">æ–‡ 1 / 8</div>
      <div id="sentence" class="sentence"></div>
      <div id="translation" class="translation"></div>

      <div class="grid" style="margin-top:8px;">
        <button id="prevBtn" class="muted">â† å‰ã®æ–‡</button>
        <button id="nextBtn" class="muted">æ¬¡ã®æ–‡ â†’</button>
      </div>

      <div class="grid" style="margin-top:10px;">
        <button id="speakCurrentBtn" class="muted">ğŸ”Š ã“ã®æ–‡ã‚’èª­ã‚€</button>
        <button id="speakAllBtn" class="muted">â–¶ 8æ–‡ã‚’é †ç•ªã«èª­ã‚€</button>
        <button id="stopSpeakBtn" class="muted">â¹ èª­ã¿ä¸Šã’åœæ­¢</button>
      </div>

      <div style="margin-top:10px;">
        <label for="ttsRate" class="small" style="display:block; margin-bottom:6px;">èª­ã¿ä¸Šã’é€Ÿåº¦</label>
        <select id="ttsRate">
          <option value="0.8">ã‚†ã£ãã‚Š (0.8x)</option>
          <option value="1" selected>ãµã¤ã† (1.0x)</option>
          <option value="1.15">å°‘ã—é€Ÿã‚ (1.15x)</option>
        </select>
      </div>

      <div id="ttsStatus" class="small" style="margin-top:8px;">èª­ã¿ä¸Šã’æº–å‚™OK</div>
    </div>

    <div class="card">
      <h1 style="font-size:20px; margin-bottom:6px;">ğŸ™ éŒ²éŸ³</h1>
      <div id="recordStatus" class="small">éŒ²éŸ³æº–å‚™OKï¼ˆãƒã‚¤ã‚¯è¨±å¯ãŒå¿…è¦ã§ã™ï¼‰</div>

      <div class="grid" style="margin-top:10px;">
        <button id="recordStartBtn" class="record">âº éŒ²éŸ³é–‹å§‹</button>
        <button id="recordStopBtn" class="muted" disabled>â–  éŒ²éŸ³åœæ­¢</button>
      </div>

      <div class="audio-wrap">
        <audio id="player" controls></audio>
        <div style="margin-top:8px;">
          <a id="downloadLink" href="#" download="speech-practice.webm" style="display:none;">â¬‡ éŒ²éŸ³ã‚’ä¿å­˜</a>
        </div>
      </div>

      <p class="small" style="margin-top:10px;">
        éŒ²éŸ³ã§ããªã„å ´åˆã¯ã€Safari/Chromeã®ãƒã‚¤ã‚¯è¨±å¯è¨­å®šã‚’ç¢ºèªã—ã¦ã­ã€‚
      </p>
    </div>
  </div>

  <script>
    (function () {
      'use strict';

      // ===== ç·´ç¿’æ–‡ï¼ˆæœã®ãƒã‚¿ãƒã‚¿ç‰ˆ 8æ–‡ï¼‰=====
      var items = [
        {
          en: "Every morning, my kids ask for many different things at the same time.",
          ja: "æ¯æœã€å­ã©ã‚‚ãŸã¡ã¯åŒæ™‚ã«ã„ã‚ã„ã‚ãªã“ã¨ã‚’æ±‚ã‚ã¦ãã¾ã™ã€‚"
        },
        {
          en: "My son gets upset quickly if I don't turn on the TV right away.",
          ja: "æ¯å­ã¯ã€ç§ãŒã™ãã«ãƒ†ãƒ¬ãƒ“ã‚’ã¤ã‘ãªã„ã¨ã€ã™ãä¸æ©Ÿå«Œã«ãªã‚Šã¾ã™ã€‚"
        },
        {
          en: "He is very motivated to do his first-grade drill worksheets.",
          ja: "å½¼ã¯å°1ã®ãƒ‰ãƒªãƒ«ã‚’ã‚„ã‚‹æ„æ¬²ãŒã¨ã¦ã‚‚é«˜ã„ã§ã™ã€‚"
        },
        {
          en: "He often wants to keep working on them for a long time.",
          ja: "å½¼ã¯ã‚ˆãã€é•·ã„æ™‚é–“ãšã£ã¨ãã‚Œã‚’ã‚„ã‚ŠãŸãŒã‚Šã¾ã™ã€‚"
        },
        {
          en: "I am happy to see his motivation and concentration.",
          ja: "ç§ã¯ã€å½¼ã®ã‚„ã‚‹æ°—ã¨é›†ä¸­åŠ›ã‚’è¦‹ã‚‹ã¨ã†ã‚Œã—ããªã‚Šã¾ã™ã€‚"
        },
        {
          en: "At the same time, I worry that he may not get enough sleep.",
          ja: "åŒæ™‚ã«ã€ç¡çœ ãŒè¶³ã‚Šãªããªã‚‹ã®ã§ã¯ãªã„ã‹ã¨å¿ƒé…ã«ãªã‚Šã¾ã™ã€‚"
        },
        {
          en: "Sometimes he wants to do drills late at night, too.",
          ja: "å¤œé…ãã«ã‚‚ãƒ‰ãƒªãƒ«ã‚’ã‚„ã‚ŠãŸãŒã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚"
        },
        {
          en: "So I try to stop him gently and help him get ready for bed.",
          ja: "ã ã‹ã‚‰ç§ã¯ã‚„ã•ã—ãæ­¢ã‚ã¦ã€å¯ã‚‹æº–å‚™ãŒã§ãã‚‹ã‚ˆã†ã«æ‰‹ä¼ã„ã¾ã™ã€‚"
        }
      ];

      // ===== ã‚¿ã‚¤ãƒãƒ¼çŠ¶æ…‹ =====
      var currentIndex = 0;
      var totalSeconds = 60;
      var remainingSeconds = 60;
      var timerId = null;
      var isRunning = false;

      // ===== éŒ²éŸ³çŠ¶æ…‹ =====
      var mediaRecorder = null;
      var mediaStream = null;
      var recordedChunks = [];
      var currentAudioUrl = null;

      // ===== è¡¨ç¤ºçŠ¶æ…‹ =====
      var isComicHidden = false;
      var isTextHidden = false;

      // ===== TTSçŠ¶æ…‹ =====
      var ttsVoices = [];
      var ttsVoice = null;
      var isSpeakingAll = false;
      var speakAllIndex = 0;

      // ===== è¦ç´ å–å¾— =====
      var timeDisplay = document.getElementById('timeDisplay');
      var statusEl = document.getElementById('status');
      var indexLabel = document.getElementById('indexLabel');
      var sentenceEl = document.getElementById('sentence');
      var translationEl = document.getElementById('translation');

      var startBtn = document.getElementById('startBtn');
      var pauseBtn = document.getElementById('pauseBtn');
      var resetBtn = document.getElementById('resetBtn');
      var minusBtn = document.getElementById('minusBtn');
      var plusBtn = document.getElementById('plusBtn');
      var shuffleBtn = document.getElementById('shuffleBtn');
      var prevBtn = document.getElementById('prevBtn');
      var nextBtn = document.getElementById('nextBtn');

      var recordStatus = document.getElementById('recordStatus');
      var recordStartBtn = document.getElementById('recordStartBtn');
      var recordStopBtn = document.getElementById('recordStopBtn');
      var player = document.getElementById('player');
      var downloadLink = document.getElementById('downloadLink');

      var comicImage = document.getElementById('comicImage');
      var comicHiddenPlaceholder = document.getElementById('comicHiddenPlaceholder');
      var toggleComicBtn = document.getElementById('toggleComicBtn');
      var toggleTextBtn = document.getElementById('toggleTextBtn');

      var speakCurrentBtn = document.getElementById('speakCurrentBtn');
      var speakAllBtn = document.getElementById('speakAllBtn');
      var stopSpeakBtn = document.getElementById('stopSpeakBtn');
      var ttsRateSelect = document.getElementById('ttsRate');
      var ttsStatus = document.getElementById('ttsStatus');

      // ===== è¡¨ç¤ºæ›´æ–° =====
      function formatTime(sec) {
        var s = Math.max(0, sec);
        var mm = Math.floor(s / 60);
        var ss = s % 60;
        return String(mm).padStart(2, '0') + ':' + String(ss).padStart(2, '0');
      }

      function renderTime() {
        timeDisplay.textContent = formatTime(remainingSeconds);
      }

      function renderSentence() {
        indexLabel.textContent = 'æ–‡ ' + (currentIndex + 1) + ' / ' + items.length;

        if (isTextHidden) {
          sentenceEl.textContent = 'ï¼ˆè‹±æ–‡ã¯éè¡¨ç¤ºï¼‰';
          translationEl.textContent = 'ï¼ˆå’Œè¨³ã¯éè¡¨ç¤ºï¼‰';
          return;
        }

        sentenceEl.textContent = items[currentIndex].en;
        translationEl.textContent = items[currentIndex].ja;
      }

      function setStatus(text) {
        statusEl.textContent = text;
      }

      function setRecordStatus(text) {
        recordStatus.textContent = text;
      }

      function setTtsStatus(text) {
        if (ttsStatus) ttsStatus.textContent = text;
      }

      function stopTimer() {
        if (timerId !== null) {
          clearInterval(timerId);
          timerId = null;
        }
        isRunning = false;
      }

      function beep() {
        try {
          var AudioCtx = window.AudioContext || window.webkitAudioContext;
          if (!AudioCtx) return;
          var ctx = new AudioCtx();
          var osc = ctx.createOscillator();
          var gain = ctx.createGain();

          osc.type = 'sine';
          osc.frequency.value = 880;
          gain.gain.value = 0.05;

          osc.connect(gain);
          gain.connect(ctx.destination);

          osc.start();
          setTimeout(function () {
            osc.stop();
            if (ctx.close) ctx.close();
          }, 180);
        } catch (e) {
          console.log('beep failed', e);
        }
      }

      function startTimer() {
        if (isRunning) return;
        if (remainingSeconds <= 0) {
          remainingSeconds = totalSeconds;
          renderTime();
        }

        isRunning = true;
        setStatus('è¨ˆæ¸¬ä¸­â€¦ è©±ã—ã¦ã¿ã‚ˆã†ï¼');

        timerId = setInterval(function () {
          remainingSeconds -= 1;
          renderTime();

          if (remainingSeconds <= 0) {
            remainingSeconds = 0;
            renderTime();
            stopTimer();
            setStatus('æ™‚é–“ã§ã™ï¼ã‚ˆãã§ãã¾ã—ãŸ âœ¨');
            beep();
          }
        }, 1000);
      }

      function pauseTimer() {
        if (!isRunning) {
          setStatus('ä¸€æ™‚åœæ­¢ä¸­');
          return;
        }
        stopTimer();
        setStatus('ä¸€æ™‚åœæ­¢ä¸­');
      }

      function resetTimer() {
        stopTimer();
        remainingSeconds = totalSeconds;
        renderTime();
        setStatus('æº–å‚™OK');
      }

      function changeTotal(delta) {
        var next = totalSeconds + delta;
        if (next < 10) next = 10;
        if (next > 600) next = 600;

        totalSeconds = next;

        if (!isRunning) {
          remainingSeconds = totalSeconds;
          renderTime();
          setStatus('æ™‚é–“è¨­å®šã‚’ ' + totalSeconds + ' ç§’ã«å¤‰æ›´');
        } else {
          setStatus('å®Ÿè¡Œä¸­ã®ãŸã‚ã€æ¬¡å›ãƒªã‚»ãƒƒãƒˆæ™‚ã« ' + totalSeconds + ' ç§’');
        }
      }

      function goPrev() {
        currentIndex = (currentIndex - 1 + items.length) % items.length;
        renderSentence();
      }

      function goNext() {
        currentIndex = (currentIndex + 1) % items.length;
        renderSentence();
      }

      function shuffleItems() {
        for (var i = items.length - 1; i > 0; i--) {
          var j = Math.floor(Math.random() * (i + 1));
          var temp = items[i];
          items[i] = items[j];
          items[j] = temp;
        }
        currentIndex = 0;
        renderSentence();
        setStatus('æ–‡ã‚’ã‚·ãƒ£ãƒƒãƒ•ãƒ«ã—ã¾ã—ãŸ');
      }

      function toggleComic() {
        isComicHidden = !isComicHidden;

        if (isComicHidden) {
          comicImage.style.display = 'none';
          comicHiddenPlaceholder.style.display = 'flex';
          toggleComicBtn.textContent = 'ğŸ‘€ 4ã‚³ãƒã‚’è¡¨ç¤º';
        } else {
          comicImage.style.display = 'block';
          comicHiddenPlaceholder.style.display = 'none';
          toggleComicBtn.textContent = 'ğŸ™ˆ 4ã‚³ãƒã‚’éš ã™';
        }
      }

      function toggleText() {
        isTextHidden = !isTextHidden;

        if (isTextHidden) {
          sentenceEl.textContent = 'ï¼ˆè‹±æ–‡ã¯éè¡¨ç¤ºï¼‰';
          translationEl.textContent = 'ï¼ˆå’Œè¨³ã¯éè¡¨ç¤ºï¼‰';
          toggleTextBtn.textContent = 'ğŸ“– è‹±æ–‡/å’Œè¨³ã‚’è¡¨ç¤º';
        } else {
          renderSentence();
          toggleTextBtn.textContent = 'ğŸ“ è‹±æ–‡/å’Œè¨³ã‚’éš ã™';
        }
      }

      // ===== éŒ²éŸ³æ©Ÿèƒ½ =====
      function supportsRecording() {
        return !!(navigator.mediaDevices &&
                  navigator.mediaDevices.getUserMedia &&
                  window.MediaRecorder);
      }

      function pickMimeType() {
        var candidates = [
          'audio/webm;codecs=opus',
          'audio/webm',
          'audio/mp4',
          'video/mp4'
        ];
        if (!window.MediaRecorder || !MediaRecorder.isTypeSupported) {
          return '';
        }
        for (var i = 0; i < candidates.length; i++) {
          if (MediaRecorder.isTypeSupported(candidates[i])) {
            return candidates[i];
          }
        }
        return '';
      }

      async function startRecording() {
        if (!supportsRecording()) {
          setRecordStatus('ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯éŒ²éŸ³ã«å¯¾å¿œã—ã¦ã„ãªã„å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™');
          alert('ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã§ã¯éŒ²éŸ³æ©Ÿèƒ½ãŒä½¿ãˆãªã„å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚Safari/Chromeæœ€æ–°ç‰ˆã§è©¦ã—ã¦ã¿ã¦ãã ã•ã„ã€‚');
          return;
        }

        if (mediaRecorder && mediaRecorder.state === 'recording') return;

        try {
          setRecordStatus('ãƒã‚¤ã‚¯è¨±å¯ã‚’ç¢ºèªä¸­â€¦');

          mediaStream = await navigator.mediaDevices.getUserMedia({ audio: true });
          recordedChunks = [];

          var options = {};
          var mimeType = pickMimeType();
          if (mimeType) {
            options.mimeType = mimeType;
          }

          mediaRecorder = new MediaRecorder(mediaStream, options);

          mediaRecorder.ondataavailable = function (e) {
            if (e.data && e.data.size > 0) {
              recordedChunks.push(e.data);
            }
          };

          mediaRecorder.onstop = function () {
            try {
              if (currentAudioUrl) {
                URL.revokeObjectURL(currentAudioUrl);
                currentAudioUrl = null;
              }

              var blobType = (mediaRecorder && mediaRecorder.mimeType) ? mediaRecorder.mimeType : 'audio/webm';
              var blob = new Blob(recordedChunks, { type: blobType });

              currentAudioUrl = URL.createObjectURL(blob);
              player.src = currentAudioUrl;

              var ext = 'webm';
              if (blobType.indexOf('mp4') !== -1) ext = 'mp4';
              downloadLink.href = currentAudioUrl;
              downloadLink.download = 'speech-practice.' + ext;
              downloadLink.style.display = 'inline';

              setRecordStatus('éŒ²éŸ³åœæ­¢ã€‚å†ç”Ÿ/ä¿å­˜ã§ãã¾ã™');
            } catch (err) {
              console.log(err);
              setRecordStatus('éŒ²éŸ³ãƒ‡ãƒ¼ã‚¿ã®å‡¦ç†ã§ã‚¨ãƒ©ãƒ¼ãŒå‡ºã¾ã—ãŸ');
            }

            if (mediaStream) {
              mediaStream.getTracks().forEach(function (t) { t.stop(); });
              mediaStream = null;
            }

            recordStartBtn.disabled = false;
            recordStopBtn.disabled = true;
            recordStartBtn.classList.remove('recording');
          };

          mediaRecorder.onerror = function (e) {
            console.log('MediaRecorder error', e);
            setRecordStatus('éŒ²éŸ³ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
            recordStartBtn.disabled = false;
            recordStopBtn.disabled = true;
            recordStartBtn.classList.remove('recording');
          };

          mediaRecorder.start();
          setRecordStatus('éŒ²éŸ³ä¸­â€¦ è©±ã—ã¦ãã ã•ã„');
          recordStartBtn.disabled = true;
          recordStopBtn.disabled = false;
          recordStartBtn.classList.add('recording');
        } catch (err) {
          console.log(err);
          if (err && (err.name === 'NotAllowedError' || err.name === 'PermissionDeniedError')) {
            setRecordStatus('ãƒã‚¤ã‚¯è¨±å¯ãŒå¿…è¦ã§ã™ï¼ˆè¨±å¯ã—ã¦ãã ã•ã„ï¼‰');
            alert('ãƒã‚¤ã‚¯ã®ä½¿ç”¨ãŒè¨±å¯ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ãƒ–ãƒ©ã‚¦ã‚¶ã®è¨­å®šã§ãƒã‚¤ã‚¯ã‚’è¨±å¯ã—ã¦ãã ã•ã„ã€‚');
          } else if (err && err.name === 'NotFoundError') {
            setRecordStatus('ãƒã‚¤ã‚¯ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
            alert('ãƒã‚¤ã‚¯ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚ç«¯æœ«è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
          } else {
            setRecordStatus('éŒ²éŸ³ã‚’é–‹å§‹ã§ãã¾ã›ã‚“ã§ã—ãŸ');
            alert('éŒ²éŸ³ã®é–‹å§‹ã«å¤±æ•—ã—ã¾ã—ãŸã€‚Safari/Chromeã§é–‹ã„ã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
          }

          if (mediaStream) {
            mediaStream.getTracks().forEach(function (t) { t.stop(); });
            mediaStream = null;
          }
          recordStartBtn.disabled = false;
          recordStopBtn.disabled = true;
          recordStartBtn.classList.remove('recording');
        }
      }

      function stopRecording() {
        try {
          if (mediaRecorder && mediaRecorder.state === 'recording') {
            mediaRecorder.stop();
            setRecordStatus('éŒ²éŸ³åœæ­¢ä¸­â€¦');
          }
        } catch (e) {
          console.log(e);
          setRecordStatus('éŒ²éŸ³åœæ­¢æ™‚ã«ã‚¨ãƒ©ãƒ¼ãŒå‡ºã¾ã—ãŸ');
        }
      }

      // ===== èª­ã¿ä¸Šã’ï¼ˆTTSï¼‰æ©Ÿèƒ½ =====
      function hasTTS() {
        return !!(window.speechSynthesis && window.SpeechSynthesisUtterance);
      }

      function loadVoices() {
        if (!hasTTS()) {
          setTtsStatus('ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯èª­ã¿ä¸Šã’ã«å¯¾å¿œã—ã¦ã„ãªã„å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™');
          return;
        }

        ttsVoices = window.speechSynthesis.getVoices() || [];

        ttsVoice =
          ttsVoices.find(function (v) { return /^en[-_]/i.test(v.lang) && /Google|Siri|Karen|Daniel|Samantha/i.test(v.name); }) ||
          ttsVoices.find(function (v) { return /^en[-_]/i.test(v.lang); }) ||
          null;

        if (ttsVoice) {
          setTtsStatus('èª­ã¿ä¸Šã’æº–å‚™OKï¼ˆ' + ttsVoice.name + ' / ' + ttsVoice.lang + 'ï¼‰');
        } else if (ttsVoices.length > 0) {
          setTtsStatus('è‹±èªéŸ³å£°ãŒè¦‹ã¤ã‹ã‚‰ãªã„ãŸã‚ã€ç«¯æœ«ã®æ—¢å®šéŸ³å£°ã‚’ä½¿ã„ã¾ã™');
        } else {
          setTtsStatus('éŸ³å£°ä¸€è¦§ã‚’èª­ã¿è¾¼ã¿ä¸­â€¦ï¼ˆå°‘ã—å¾…ã£ã¦ã‹ã‚‰æŠ¼ã—ã¦ã¿ã¦ã­ï¼‰');
        }
      }

      function stopSpeaking() {
        if (!hasTTS()) return;
        isSpeakingAll = false;
        try {
          window.speechSynthesis.cancel();
        } catch (e) {
          console.log(e);
        }
        setTtsStatus('èª­ã¿ä¸Šã’åœæ­¢');
      }

      function speakText(text, onEnd) {
        if (!hasTTS()) {
          setTtsStatus('ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã§ã¯èª­ã¿ä¸Šã’ãŒä½¿ãˆãªã„å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™');
          return;
        }

        try {
          window.speechSynthesis.cancel();
        } catch (e) {
          console.log(e);
        }

        var utt = new SpeechSynthesisUtterance(text);
        var rate = parseFloat(ttsRateSelect.value || '1');

        utt.rate = rate;
        utt.pitch = 1.0;
        utt.volume = 1.0;

        if (ttsVoice) {
          utt.voice = ttsVoice;
          utt.lang = ttsVoice.lang || 'en-US';
        } else {
          utt.lang = 'en-US';
        }

        utt.onstart = function () {
          setTtsStatus('èª­ã¿ä¸Šã’ä¸­â€¦');
        };

        utt.onend = function () {
          if (typeof onEnd === 'function') onEnd();
          else setTtsStatus('èª­ã¿ä¸Šã’å®Œäº†');
        };

        utt.onerror = function (e) {
          console.log('TTS error', e);
          setTtsStatus('èª­ã¿ä¸Šã’ã‚¨ãƒ©ãƒ¼ï¼ˆã‚‚ã†ä¸€åº¦è©¦ã—ã¦ã¿ã¦ã­ï¼‰');
          isSpeakingAll = false;
        };

        window.speechSynthesis.speak(utt);
      }

      function speakCurrentSentence() {
        isSpeakingAll = false;
        speakText(items[currentIndex].en);
      }

      function speakAllSentences() {
        if (!hasTTS()) {
          setTtsStatus('ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã§ã¯èª­ã¿ä¸Šã’ãŒä½¿ãˆãªã„å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™');
          return;
        }

        try {
          window.speechSynthesis.cancel();
        } catch (e) {
          console.log(e);
        }

        isSpeakingAll = true;
        speakAllIndex = 0;

        function nextSpeak() {
          if (!isSpeakingAll) return;

          if (speakAllIndex >= items.length) {
            isSpeakingAll = false;
            setTtsStatus('8æ–‡ã®èª­ã¿ä¸Šã’å®Œäº†');
            return;
          }

          currentIndex = speakAllIndex;
          renderSentence();

          var text = items[speakAllIndex].en;
          speakAllIndex += 1;

          speakText(text, function () {
            if (!isSpeakingAll) return;
            setTimeout(nextSpeak, 350);
          });
        }

        nextSpeak();
      }

      // ===== ã‚¤ãƒ™ãƒ³ãƒˆ =====
      startBtn.addEventListener('click', startTimer);
      pauseBtn.addEventListener('click', pauseTimer);
      resetBtn.addEventListener('click', resetTimer);
      minusBtn.addEventListener('click', function () { changeTotal(-10); });
      plusBtn.addEventListener('click', function () { changeTotal(10); });
      shuffleBtn.addEventListener('click', shuffleItems);
      prevBtn.addEventListener('click', goPrev);
      nextBtn.addEventListener('click', goNext);

      toggleComicBtn.addEventListener('click', toggleComic);
      toggleTextBtn.addEventListener('click', toggleText);

      recordStartBtn.addEventListener('click', function () {
        startRecording();
      });
      recordStopBtn.addEventListener('click', stopRecording);

      speakCurrentBtn.addEventListener('click', speakCurrentSentence);
      speakAllBtn.addEventListener('click', speakAllSentences);
      stopSpeakBtn.addEventListener('click', stopSpeaking);

      // ===== åˆæœŸåŒ– =====
      renderTime();
      renderSentence();
      setStatus('æº–å‚™OK');

      if (!supportsRecording()) {
        setRecordStatus('ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã§ã¯éŒ²éŸ³æ©Ÿèƒ½ãŒä½¿ãˆãªã„å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™');
      } else {
        setRecordStatus('éŒ²éŸ³æº–å‚™OKï¼ˆâº éŒ²éŸ³é–‹å§‹ã‚’æŠ¼ã—ã¦ãã ã•ã„ï¼‰');
      }

      if (hasTTS()) {
        loadVoices();

        if (typeof window.speechSynthesis.onvoiceschanged !== 'undefined') {
          window.speechSynthesis.onvoiceschanged = loadVoices;
        }

        setTimeout(loadVoices, 500);
      } else {
        setTtsStatus('ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã§ã¯èª­ã¿ä¸Šã’ãŒä½¿ãˆãªã„å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™');
      }

      // ç”»åƒèª­ã¿è¾¼ã¿å¤±æ•—æ™‚ã®è£œåŠ©è¡¨ç¤º
      comicImage.addEventListener('error', function () {
        comicImage.style.display = 'none';
        comicHiddenPlaceholder.style.display = 'flex';
        comicHiddenPlaceholder.innerHTML = '4ã‚³ãƒç”»åƒãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚<br>ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«åï¼ˆsrcï¼‰ã‚’ç¢ºèªã—ã¦ã­ã€‚';
        toggleComicBtn.textContent = 'ğŸ‘€ 4ã‚³ãƒã‚’è¡¨ç¤º';
        isComicHidden = true;
      });
    })();
  </script>
</body>
</html>
