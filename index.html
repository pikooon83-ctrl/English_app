<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>1åˆ†ã‚¹ãƒ”ãƒ¼ãƒç·´ç¿’ã‚¿ã‚¤ãƒãƒ¼ï¼ˆéŒ²éŸ³ã¤ãï¼‰</title>
  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background: #f7f8fb;
      color: #222;
      line-height: 1.5;
    }
    .wrap {
      max-width: 760px;
      margin: 0 auto;
      padding: 16px;
    }
    .card {
      background: #fff;
      border-radius: 16px;
      padding: 16px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.06);
      margin-bottom: 16px;
    }
    h1 {
      font-size: 22px;
      margin: 0 0 8px;
    }
    .sub {
      color: #666;
      font-size: 14px;
      margin-bottom: 12px;
    }
    .time {
      font-size: 56px;
      font-weight: 700;
      text-align: center;
      letter-spacing: 1px;
      margin: 8px 0 12px;
    }
    .status {
      text-align: center;
      font-size: 14px;
      color: #555;
      min-height: 1.4em;
      margin-bottom: 12px;
    }
    .grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0,1fr));
      gap: 10px;
    }
    button {
      width: 100%;
      padding: 14px 12px;
      border: none;
      border-radius: 12px;
      font-size: 16px;
      font-weight: 600;
      background: #e9edf5;
      color: #222;
      cursor: pointer;
      -webkit-tap-highlight-color: transparent;
    }
    button:disabled {
      opacity: 0.55;
      cursor: not-allowed;
    }
    button:active {
      transform: scale(0.99);
    }
    .primary { background: #1f6feb; color: #fff; }
    .danger  { background: #e5484d; color: #fff; }
    .muted   { background: #eef1f6; color: #444; }
    .record  { background: #d92d20; color: #fff; }
    .recording {
      box-shadow: 0 0 0 4px rgba(217,45,32,0.18) inset;
    }

    .sentence {
      font-size: 20px;
      font-weight: 600;
      margin: 8px 0 6px;
    }
    .translation {
      color: #666;
      font-size: 14px;
      margin-bottom: 8px;
    }
    .small {
      font-size: 13px;
      color: #666;
    }
    .audio-wrap {
      margin-top: 10px;
    }
    audio {
      width: 100%;
      margin-top: 8px;
    }

    @media (min-width: 680px) {
      .grid {
        grid-template-columns: repeat(3, minmax(0,1fr));
      }
      .time { font-size: 68px; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>â± 1åˆ†ã‚¹ãƒ”ãƒ¼ãƒç·´ç¿’ã‚¿ã‚¤ãƒãƒ¼ï¼ˆéŒ²éŸ³ã¤ãï¼‰</h1>
      <div class="sub">ã¾ãšã¯ã‚¿ã‚¤ãƒãƒ¼ï¼‹éŒ²éŸ³ã ã‘ã®ã‚·ãƒ³ãƒ—ãƒ«ç‰ˆ</div>

      <div id="timeDisplay" class="time">01:00</div>
      <div id="status" class="status">æº–å‚™OK</div>

      <div class="grid">
        <button id="startBtn" class="primary">â–¶ é–‹å§‹</button>
        <button id="pauseBtn" class="muted">â¸ ä¸€æ™‚åœæ­¢</button>
        <button id="resetBtn" class="danger">â†º ãƒªã‚»ãƒƒãƒˆ</button>
        <button id="minusBtn" class="muted">âˆ’10ç§’</button>
        <button id="plusBtn" class="muted">ï¼‹10ç§’</button>
        <button id="shuffleBtn" class="muted">ğŸ”€ æ–‡ã‚’ã‚·ãƒ£ãƒƒãƒ•ãƒ«</button>
      </div>

      <p class="small" style="margin-top:10px;">
        ä½¿ã„æ–¹ï¼šé–‹å§‹ â†’ 1åˆ†è©±ã™ â†’ 0ç§’ã§çµ‚äº†éŸ³ï¼ˆç«¯æœ«è¨­å®šã«ã‚ˆã‚‹ï¼‰
      </p>
    </div>

    <div class="card">
      <div class="small" id="indexLabel">æ–‡ 1 / 8</div>
      <div id="sentence" class="sentence"></div>
      <div id="translation" class="translation"></div>

      <div class="grid" style="margin-top:8px;">
        <button id="prevBtn" class="muted">â† å‰ã®æ–‡</button>
        <button id="nextBtn" class="muted">æ¬¡ã®æ–‡ â†’</button>
      </div>
    </div>

    <div class="card">
      <h1 style="font-size:20px; margin-bottom:6px;">ğŸ™ éŒ²éŸ³</h1>
      <div id="recordStatus" class="small">éŒ²éŸ³æº–å‚™OKï¼ˆãƒã‚¤ã‚¯è¨±å¯ãŒå¿…è¦ã§ã™ï¼‰</div>

      <div class="grid" style="margin-top:10px;">
        <button id="recordStartBtn" class="record">âº éŒ²éŸ³é–‹å§‹</button>
        <button id="recordStopBtn" class="muted" disabled>â–  éŒ²éŸ³åœæ­¢</button>
      </div>

      <div class="audio-wrap">
        <audio id="player" controls></audio>
        <div style="margin-top:8px;">
          <a id="downloadLink" href="#" download="speech-practice.webm" style="display:none;">â¬‡ éŒ²éŸ³ã‚’ä¿å­˜</a>
        </div>
      </div>

      <p class="small" style="margin-top:10px;">
        éŒ²éŸ³ã§ããªã„å ´åˆã¯ã€Safari/Chromeã®ãƒã‚¤ã‚¯è¨±å¯è¨­å®šã‚’ç¢ºèªã—ã¦ã­ã€‚
      </p>
    </div>
  </div>

  <script>
    (function () {
      'use strict';

      // ===== ç·´ç¿’æ–‡ï¼ˆå…ƒã®8æ–‡ï¼‰=====
      var items = [
        {
          en: "I have to listen to my kids' various demands every morning.",
          ja: "ç§ã¯æ¯æœã€å­ã©ã‚‚ãŸã¡ã®ã„ã‚ã„ã‚ãªè¦æ±‚ã‚’èã‹ãªã„ã¨ã„ã‘ã¾ã›ã‚“ã€‚"
        },
        {
          en: "My son gets angry immediately when I don't turn on the TV.",
          ja: "æ¯å­ã¯ç§ãŒãƒ†ãƒ¬ãƒ“ã‚’ã¤ã‘ãªã„ã¨ã€ã™ãæ€’ã‚Šã¾ã™ã€‚"
        },
        {
          en: "I want to stay calm, but I sometimes lose patience.",
          ja: "è½ã¡ç€ã„ã¦ã„ãŸã„ã®ã§ã™ãŒã€æ™‚ã€…æˆ‘æ…¢ã§ããªããªã‚Šã¾ã™ã€‚"
        },
        {
          en: "I am practicing speaking English little by little every day.",
          ja: "ç§ã¯æ¯æ—¥å°‘ã—ãšã¤è‹±èªã‚’è©±ã™ç·´ç¿’ã‚’ã—ã¦ã„ã¾ã™ã€‚"
        },
        {
          en: "I want to make a one-minute speech smoothly.",
          ja: "ç§ã¯1åˆ†é–“ã®ã‚¹ãƒ”ãƒ¼ãƒã‚’ã‚¹ãƒ ãƒ¼ã‚ºã«è©±ã›ã‚‹ã‚ˆã†ã«ãªã‚ŠãŸã„ã§ã™ã€‚"
        },
        {
          en: "Even if I make mistakes, I want to keep speaking.",
          ja: "é–“é•ãˆã¦ã‚‚ã€è©±ã—ç¶šã‘ãŸã„ã§ã™ã€‚"
        },
        {
          en: "I can improve if I practice step by step.",
          ja: "å°‘ã—ãšã¤ç·´ç¿’ã™ã‚Œã°ã€ç§ã¯ä¸Šé”ã§ãã¾ã™ã€‚"
        },
        {
          en: "Today, I will do my best and finish in one minute.",
          ja: "ä»Šæ—¥ã¯ãƒ™ã‚¹ãƒˆã‚’å°½ãã—ã¦ã€1åˆ†ã§è©±ã—åˆ‡ã‚Šã¾ã™ã€‚"
        }
      ];

      // ===== ã‚¿ã‚¤ãƒãƒ¼çŠ¶æ…‹ =====
      var currentIndex = 0;
      var totalSeconds = 60;
      var remainingSeconds = 60;
      var timerId = null;
      var isRunning = false;

      // ===== éŒ²éŸ³çŠ¶æ…‹ =====
      var mediaRecorder = null;
      var mediaStream = null;
      var recordedChunks = [];
      var currentAudioUrl = null;

      // ===== è¦ç´ å–å¾— =====
      var timeDisplay = document.getElementById('timeDisplay');
      var statusEl = document.getElementById('status');
      var indexLabel = document.getElementById('indexLabel');
      var sentenceEl = document.getElementById('sentence');
      var translationEl = document.getElementById('translation');

      var startBtn = document.getElementById('startBtn');
      var pauseBtn = document.getElementById('pauseBtn');
      var resetBtn = document.getElementById('resetBtn');
      var minusBtn = document.getElementById('minusBtn');
      var plusBtn = document.getElementById('plusBtn');
      var shuffleBtn = document.getElementById('shuffleBtn');
      var prevBtn = document.getElementById('prevBtn');
      var nextBtn = document.getElementById('nextBtn');

      var recordStatus = document.getElementById('recordStatus');
      var recordStartBtn = document.getElementById('recordStartBtn');
      var recordStopBtn = document.getElementById('recordStopBtn');
      var player = document.getElementById('player');
      var downloadLink = document.getElementById('downloadLink');

      // ===== è¡¨ç¤ºæ›´æ–° =====
      function formatTime(sec) {
        var s = Math.max(0, sec);
        var mm = Math.floor(s / 60);
        var ss = s % 60;
        return String(mm).padStart(2, '0') + ':' + String(ss).padStart(2, '0');
      }

      function renderTime() {
        timeDisplay.textContent = formatTime(remainingSeconds);
      }

      function renderSentence() {
        indexLabel.textContent = 'æ–‡ ' + (currentIndex + 1) + ' / ' + items.length;
        sentenceEl.textContent = items[currentIndex].en;
        translationEl.textContent = items[currentIndex].ja;
      }

      function setStatus(text) {
        statusEl.textContent = text;
      }

      function setRecordStatus(text) {
        recordStatus.textContent = text;
      }

      function stopTimer() {
        if (timerId !== null) {
          clearInterval(timerId);
          timerId = null;
        }
        isRunning = false;
      }

      function beep() {
        try {
          var AudioCtx = window.AudioContext || window.webkitAudioContext;
          if (!AudioCtx) return;
          var ctx = new AudioCtx();
          var osc = ctx.createOscillator();
          var gain = ctx.createGain();

          osc.type = 'sine';
          osc.frequency.value = 880;
          gain.gain.value = 0.05;

          osc.connect(gain);
          gain.connect(ctx.destination);

          osc.start();
          setTimeout(function () {
            osc.stop();
            if (ctx.close) ctx.close();
          }, 180);
        } catch (e) {
          console.log('beep failed', e);
        }
      }

      function startTimer() {
        if (isRunning) return;
        if (remainingSeconds <= 0) {
          remainingSeconds = totalSeconds;
          renderTime();
        }

        isRunning = true;
        setStatus('è¨ˆæ¸¬ä¸­â€¦ è©±ã—ã¦ã¿ã‚ˆã†ï¼');

        timerId = setInterval(function () {
          remainingSeconds -= 1;
          renderTime();

          if (remainingSeconds <= 0) {
            remainingSeconds = 0;
            renderTime();
            stopTimer();
            setStatus('æ™‚é–“ã§ã™ï¼ã‚ˆãã§ãã¾ã—ãŸ âœ¨');
            beep();
          }
        }, 1000);
      }

      function pauseTimer() {
        if (!isRunning) {
          setStatus('ä¸€æ™‚åœæ­¢ä¸­');
          return;
        }
        stopTimer();
        setStatus('ä¸€æ™‚åœæ­¢ä¸­');
      }

      function resetTimer() {
        stopTimer();
        remainingSeconds = totalSeconds;
        renderTime();
        setStatus('æº–å‚™OK');
      }

      function changeTotal(delta) {
        var next = totalSeconds + delta;
        if (next < 10) next = 10;
        if (next > 600) next = 600;

        totalSeconds = next;

        if (!isRunning) {
          remainingSeconds = totalSeconds;
          renderTime();
          setStatus('æ™‚é–“è¨­å®šã‚’ ' + totalSeconds + ' ç§’ã«å¤‰æ›´');
        } else {
          setStatus('å®Ÿè¡Œä¸­ã®ãŸã‚ã€æ¬¡å›ãƒªã‚»ãƒƒãƒˆæ™‚ã« ' + totalSeconds + ' ç§’');
        }
      }

      function goPrev() {
        currentIndex = (currentIndex - 1 + items.length) % items.length;
        renderSentence();
      }

      function goNext() {
        currentIndex = (currentIndex + 1) % items.length;
        renderSentence();
      }

      function shuffleItems() {
        for (var i = items.length - 1; i > 0; i--) {
          var j = Math.floor(Math.random() * (i + 1));
          var temp = items[i];
          items[i] = items[j];
          items[j] = temp;
        }
        currentIndex = 0;
        renderSentence();
        setStatus('æ–‡ã‚’ã‚·ãƒ£ãƒƒãƒ•ãƒ«ã—ã¾ã—ãŸ');
      }

      // ===== éŒ²éŸ³æ©Ÿèƒ½ =====
      function supportsRecording() {
        return !!(navigator.mediaDevices &&
                  navigator.mediaDevices.getUserMedia &&
                  window.MediaRecorder);
      }

      function pickMimeType() {
        var candidates = [
          'audio/webm;codecs=opus',
          'audio/webm',
          'audio/mp4',
          'video/mp4' // iOSç³»ã®ç›¸æ€§å›é¿ç”¨ï¼ˆéŸ³å£°ã®ã¿ã§ã‚‚ã‚³ãƒ³ãƒ†ãƒŠã¨ã—ã¦ï¼‰
        ];
        if (!window.MediaRecorder || !MediaRecorder.isTypeSupported) {
          return '';
        }
        for (var i = 0; i < candidates.length; i++) {
          if (MediaRecorder.isTypeSupported(candidates[i])) {
            return candidates[i];
          }
        }
        return '';
      }

      async function startRecording() {
        if (!supportsRecording()) {
          setRecordStatus('ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯éŒ²éŸ³ã«å¯¾å¿œã—ã¦ã„ãªã„å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™');
          alert('ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã§ã¯éŒ²éŸ³æ©Ÿèƒ½ãŒä½¿ãˆãªã„å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚Safari/Chromeæœ€æ–°ç‰ˆã§è©¦ã—ã¦ã¿ã¦ãã ã•ã„ã€‚');
          return;
        }

        // ã™ã§ã«éŒ²éŸ³ä¸­ãªã‚‰ä½•ã‚‚ã—ãªã„
        if (mediaRecorder && mediaRecorder.state === 'recording') return;

        try {
          setRecordStatus('ãƒã‚¤ã‚¯è¨±å¯ã‚’ç¢ºèªä¸­â€¦');

          mediaStream = await navigator.mediaDevices.getUserMedia({ audio: true });

          recordedChunks = [];

          var options = {};
          var mimeType = pickMimeType();
          if (mimeType) {
            options.mimeType = mimeType;
          }

          mediaRecorder = new MediaRecorder(mediaStream, options);

          mediaRecorder.ondataavailable = function (e) {
            if (e.data && e.data.size > 0) {
              recordedChunks.push(e.data);
            }
          };

          mediaRecorder.onstop = function () {
            try {
              if (currentAudioUrl) {
                URL.revokeObjectURL(currentAudioUrl);
                currentAudioUrl = null;
              }

              var blobType = (mediaRecorder && mediaRecorder.mimeType) ? mediaRecorder.mimeType : 'audio/webm';
              var blob = new Blob(recordedChunks, { type: blobType });

              currentAudioUrl = URL.createObjectURL(blob);
              player.src = currentAudioUrl;

              var ext = 'webm';
              if (blobType.indexOf('mp4') !== -1) ext = 'mp4';
              downloadLink.href = currentAudioUrl;
              downloadLink.download = 'speech-practice.' + ext;
              downloadLink.style.display = 'inline';

              setRecordStatus('éŒ²éŸ³åœæ­¢ã€‚å†ç”Ÿ/ä¿å­˜ã§ãã¾ã™');
            } catch (err) {
              console.log(err);
              setRecordStatus('éŒ²éŸ³ãƒ‡ãƒ¼ã‚¿ã®å‡¦ç†ã§ã‚¨ãƒ©ãƒ¼ãŒå‡ºã¾ã—ãŸ');
            }

            // ãƒã‚¤ã‚¯è§£æ”¾
            if (mediaStream) {
              mediaStream.getTracks().forEach(function (t) { t.stop(); });
              mediaStream = null;
            }

            recordStartBtn.disabled = false;
            recordStopBtn.disabled = true;
            recordStartBtn.classList.remove('recording');
          };

          mediaRecorder.onerror = function (e) {
            console.log('MediaRecorder error', e);
            setRecordStatus('éŒ²éŸ³ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
            recordStartBtn.disabled = false;
            recordStopBtn.disabled = true;
            recordStartBtn.classList.remove('recording');
          };

          mediaRecorder.start();
          setRecordStatus('éŒ²éŸ³ä¸­â€¦ è©±ã—ã¦ãã ã•ã„');
          recordStartBtn.disabled = true;
          recordStopBtn.disabled = false;
          recordStartBtn.classList.add('recording');
        } catch (err) {
          console.log(err);
          if (err && (err.name === 'NotAllowedError' || err.name === 'PermissionDeniedError')) {
            setRecordStatus('ãƒã‚¤ã‚¯è¨±å¯ãŒå¿…è¦ã§ã™ï¼ˆè¨±å¯ã—ã¦ãã ã•ã„ï¼‰');
            alert('ãƒã‚¤ã‚¯ã®ä½¿ç”¨ãŒè¨±å¯ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ãƒ–ãƒ©ã‚¦ã‚¶ã®è¨­å®šã§ãƒã‚¤ã‚¯ã‚’è¨±å¯ã—ã¦ãã ã•ã„ã€‚');
          } else if (err && err.name === 'NotFoundError') {
            setRecordStatus('ãƒã‚¤ã‚¯ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
            alert('ãƒã‚¤ã‚¯ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚ç«¯æœ«è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
          } else {
            setRecordStatus('éŒ²éŸ³ã‚’é–‹å§‹ã§ãã¾ã›ã‚“ã§ã—ãŸ');
            alert('éŒ²éŸ³ã®é–‹å§‹ã«å¤±æ•—ã—ã¾ã—ãŸã€‚Safari/Chromeã§é–‹ã„ã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
          }

          if (mediaStream) {
            mediaStream.getTracks().forEach(function (t) { t.stop(); });
            mediaStream = null;
          }
          recordStartBtn.disabled = false;
          recordStopBtn.disabled = true;
          recordStartBtn.classList.remove('recording');
        }
      }

      function stopRecording() {
        try {
          if (mediaRecorder && mediaRecorder.state === 'recording') {
            mediaRecorder.stop();
            setRecordStatus('éŒ²éŸ³åœæ­¢ä¸­â€¦');
          }
        } catch (e) {
          console.log(e);
          setRecordStatus('éŒ²éŸ³åœæ­¢æ™‚ã«ã‚¨ãƒ©ãƒ¼ãŒå‡ºã¾ã—ãŸ');
        }
      }

      // ===== ã‚¤ãƒ™ãƒ³ãƒˆ =====
      startBtn.addEventListener('click', startTimer);
      pauseBtn.addEventListener('click', pauseTimer);
      resetBtn.addEventListener('click', resetTimer);
      minusBtn.addEventListener('click', function () { changeTotal(-10); });
      plusBtn.addEventListener('click', function () { changeTotal(10); });
      shuffleBtn.addEventListener('click', shuffleItems);
      prevBtn.addEventListener('click', goPrev);
      nextBtn.addEventListener('click', goNext);

      recordStartBtn.addEventListener('click', function () {
        startRecording();
      });
      recordStopBtn.addEventListener('click', stopRecording);

      // ===== åˆæœŸåŒ– =====
      renderTime();
      renderSentence();
      setStatus('æº–å‚™OK');

      if (!supportsRecording()) {
        setRecordStatus('ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã§ã¯éŒ²éŸ³æ©Ÿèƒ½ãŒä½¿ãˆãªã„å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™');
      } else {
        setRecordStatus('éŒ²éŸ³æº–å‚™OKï¼ˆâº éŒ²éŸ³é–‹å§‹ã‚’æŠ¼ã—ã¦ãã ã•ã„ï¼‰');
      }
    })();
  </script>
</body>
</html>
