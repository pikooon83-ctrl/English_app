<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>1åˆ†ã‚¹ãƒ”ãƒ¼ãƒç·´ç¿’ã‚¿ã‚¤ãƒãƒ¼ï¼‹éŒ²éŸ³ï¼‹æ–‡å­—èµ·ã“ã—</title>
<style>
  :root { --bg:#f7f7fb; --card:#fff; --ink:#222; --muted:#666; --line:#e4e4ee; --accent:#3b82f6; }
  * { box-sizing:border-box; }
  body { margin:0; font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,'Hiragino Sans','Yu Gothic UI',sans-serif; background:var(--bg); color:var(--ink); }
  .wrap { max-width:860px; margin:0 auto; padding:16px; }
  .card { background:var(--card); border:1px solid var(--line); border-radius:14px; padding:14px; margin-bottom:12px; box-shadow:0 1px 2px rgba(0,0,0,.04); }
  h1 { font-size:20px; margin:0 0 8px; }
  h2 { font-size:16px; margin:0 0 10px; }
  .timer { text-align:center; font-size:44px; font-weight:700; letter-spacing:1px; margin:8px 0; }
  .timer.done { color:#dc2626; }
  .row { display:flex; gap:8px; flex-wrap:wrap; }
  button { border:none; background:#111827; color:#fff; padding:12px 14px; border-radius:10px; font-size:15px; min-height:44px; }
  button.secondary { background:#e5e7eb; color:#111827; }
  button.accent { background:var(--accent); }
  button.warn { background:#ef4444; }
  button:disabled { opacity:.45; }
  .muted { color:var(--muted); font-size:13px; line-height:1.45; }
  .sentence { padding:10px; border:1px solid var(--line); border-radius:10px; margin-bottom:8px; background:#fafafe; }
  .sentence.active { border-color:var(--accent); background:#eff6ff; }
  .en { font-weight:600; line-height:1.45; }
  .ja { margin-top:4px; color:#555; font-size:14px; }
  .indexpill { display:inline-block; min-width:28px; text-align:center; padding:3px 8px; border-radius:999px; background:#eef2ff; color:#3730a3; font-size:12px; margin-right:8px; }
  textarea { width:100%; min-height:110px; border:1px solid var(--line); border-radius:10px; padding:10px; font-size:15px; }
  audio { width:100%; margin-top:8px; }
  .status { font-weight:600; }
  .ok { color:#065f46; } .bad { color:#991b1b; } .info { color:#1d4ed8; }
  .small { font-size:12px; }
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h1>1åˆ†ã‚¹ãƒ”ãƒ¼ãƒç·´ç¿’ï¼ˆã‚¿ã‚¤ãƒãƒ¼ï¼‹éŒ²éŸ³ï¼‹æ–‡å­—èµ·ã“ã—ï¼‰</h1>
    <div class="muted">1åˆ†ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³ã§ç·´ç¿’ã—ãªãŒã‚‰ã€ã‚ãªãŸã®å£°ã‚’éŒ²éŸ³ã§ãã¾ã™ã€‚æ–‡å­—èµ·ã“ã—ã¯ãƒ–ãƒ©ã‚¦ã‚¶å¯¾å¿œæ™‚ã®ã¿å‹•ä½œã—ã¾ã™ï¼ˆä¸»ã«Chromeç³»ï¼‰ã€‚Safari/Yahooãƒ¡ãƒ¼ãƒ«å†…ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã§ã¯æœªå¯¾å¿œã®ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚</div>
  </div>

  <div class="card">
    <h2>â‘  1åˆ†ã‚¿ã‚¤ãƒãƒ¼</h2>
    <div class="timer" id="timer">01:00</div>
    <div class="row">
      <button class="accent" id="startTimerBtn">â–¶ ã‚¿ã‚¤ãƒãƒ¼é–‹å§‹</button>
      <button class="secondary" id="pauseTimerBtn">â¸ ä¸€æ™‚åœæ­¢</button>
      <button class="secondary" id="resetTimerBtn">â†º 60ç§’ã«æˆ»ã™</button>
      <button class="secondary" id="plus10Btn">+10ç§’</button>
      <button class="secondary" id="minus10Btn">-10ç§’</button>
    </div>
    <div class="muted small" style="margin-top:8px;">çµ‚äº†æ™‚ã«ãƒã‚¤ãƒ–ã¯ã§ããªã„ç’°å¢ƒãŒã‚ã‚‹ã®ã§ã€ç”»é¢è‰²å¤‰æ›´ï¼‹éŸ³ã§çŸ¥ã‚‰ã›ã¾ã™ã€‚</div>
  </div>

  <div class="card">
    <h2>â‘¡ ã‚¹ãƒ”ãƒ¼ãƒå†…å®¹ï¼ˆ8æ–‡ï¼‰</h2>
    <div id="sentences"></div>
    <div class="row">
      <button class="secondary" id="prevSentenceBtn">â† å‰ã®æ–‡</button>
      <button class="secondary" id="nextSentenceBtn">æ¬¡ã®æ–‡ â†’</button>
      <button id="speakSentenceBtn">ğŸ”Š ã“ã®æ–‡ã‚’èª­ã‚€</button>
      <button class="secondary" id="speakAllBtn">â–¶ 8æ–‡ã‚’é †ã«èª­ã‚€</button>
    </div>
  </div>

  <div class="card">
    <h2>â‘¢ éŒ²éŸ³</h2>
    <div class="row">
      <button class="accent" id="startRecBtn">âº éŒ²éŸ³é–‹å§‹</button>
      <button class="warn" id="stopRecBtn" disabled>â–  éŒ²éŸ³åœæ­¢</button>
      <button class="secondary" id="clearRecBtn">ã‚¯ãƒªã‚¢</button>
    </div>
    <p class="muted" id="recStatus">éŒ²éŸ³å¾…æ©Ÿä¸­</p>
    <audio id="audioPlayer" controls hidden></audio>
    <div id="downloadWrap"></div>
  </div>

  <div class="card">
    <h2>â‘£ æ–‡å­—èµ·ã“ã—ï¼ˆå¯¾å¿œãƒ–ãƒ©ã‚¦ã‚¶ã®ã¿ï¼‰</h2>
    <div class="row">
      <button class="accent" id="startTransBtn">ğŸ¤ æ–‡å­—èµ·ã“ã—é–‹å§‹</button>
      <button class="warn" id="stopTransBtn" disabled>åœæ­¢</button>
      <button class="secondary" id="copyTransBtn">ã‚³ãƒ”ãƒ¼</button>
      <button class="secondary" id="clearTransBtn">ã‚¯ãƒªã‚¢</button>
    </div>
    <p class="muted" id="transStatus">æœªé–‹å§‹</p>
    <textarea id="transcript" placeholder="ã“ã“ã«æ–‡å­—èµ·ã“ã—çµæœãŒå…¥ã‚Šã¾ã™ï¼ˆæœªå¯¾å¿œãƒ–ãƒ©ã‚¦ã‚¶ã§ã¯æ‰‹å…¥åŠ›ãƒ¡ãƒ¢ã«ã‚‚ä½¿ãˆã¾ã™ï¼‰"></textarea>
  </div>
</div>

<script>
const SENTENCES = [{"en": "I have to listen to my kids' various demands every morning.", "ja": "æ¯æœã€å­ä¾›ãŸã¡ã®è‰²ã€…ãªè¦æ±‚ã‚’èã‹ãªã‘ã‚Œã°ãªã‚Šã¾ã›ã‚“ã€‚"}, {"en": "Itâ€™s hard to play with them while getting ready.", "ja": "æ”¯åº¦ã‚’ã—ãªãŒã‚‰éŠã³ã«ä»˜ãåˆã†ã®ã¯å¤§å¤‰ã§ã™ã€‚"}, {"en": "Our morning routine is always chaotic.", "ja": "ã†ã¡ã®æœã®æ”¯åº¦ã¯ã„ã¤ã‚‚ãƒã‚¿ãƒã‚¿ã—ã¦ã„ã¾ã™ã€‚"}, {"en": "My son was doing his workbook for ages.", "ja": "æ¯å­ã¯ã„ã¤ã¾ã§ã‚‚ãƒ‰ãƒªãƒ«ã‚’ã‚„ã£ã¦ã„ã¾ã—ãŸã€‚"}, {"en": "He finished a whole workbook for first graders!", "ja": "å½¼ã¯å°å­¦1å¹´ç”Ÿç”¨ã®ãƒ‰ãƒªãƒ«ã‚’ä¸¸ã€…ä¸€å†Šçµ‚ã‚ã‚‰ã›ã¾ã—ãŸï¼"}, {"en": "He has amazing concentration for a five-year-old.", "ja": "å½¼ã¯5æ­³ã«ã—ã¦ã¯ç´ æ™´ã‚‰ã—ã„é›†ä¸­åŠ›ã‚’æŒã£ã¦ã„ã¾ã™ã€‚"}, {"en": "Iâ€™m worried about his lack of sleep.", "ja": "å½¼ã®ç¡çœ ä¸è¶³ãŒå¿ƒé…ã§ã™ã€‚"}, {"en": "It's exhausting to handle everything at once.", "ja": "å…¨ã¦ã‚’ä¸€åº¦ã«ã“ãªã™ã®ã¯æœ¬å½“ã«ç–²ã‚Œæœã¦ã¾ã™ã€‚"}];
let currentIndex = 0;
let speakAllMode = false;

const sentencesEl = document.getElementById('sentences');
function renderSentences() {
  sentencesEl.innerHTML = '';
  SENTENCES.forEach((s, i) => {
    const d = document.createElement('div');
    d.className = 'sentence' + (i === currentIndex ? ' active' : '');
    d.innerHTML = `<div class="en"><span class="indexpill">${i+1}/8</span>${escapeHtml(s.en)}</div>${s.ja ? `<div class="ja">${escapeHtml(s.ja)}</div>` : ''}`;
    d.addEventListener('click', () => { currentIndex = i; renderSentences(); });
    sentencesEl.appendChild(d);
  });
}
function escapeHtml(str) {
  return String(str).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
}
renderSentences();

document.getElementById('prevSentenceBtn').addEventListener('click', () => { currentIndex = (currentIndex - 1 + SENTENCES.length) % SENTENCES.length; renderSentences(); });
document.getElementById('nextSentenceBtn').addEventListener('click', () => { currentIndex = (currentIndex + 1) % SENTENCES.length; renderSentences(); });

// Speech synthesis for sentence practice
function speakText(text, onEnd) {
  if (!('speechSynthesis' in window)) { alert('ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯èª­ã¿ä¸Šã’ã«æœªå¯¾å¿œã§ã™'); return; }
  window.speechSynthesis.cancel();
  const u = new SpeechSynthesisUtterance(text);
  u.lang = 'en-US';
  u.rate = 0.95;
  u.onend = () => onEnd && onEnd();
  window.speechSynthesis.speak(u);
}
document.getElementById('speakSentenceBtn').addEventListener('click', () => {
  speakAllMode = false;
  speakText(SENTENCES[currentIndex].en);
});
document.getElementById('speakAllBtn').addEventListener('click', () => {
  speakAllMode = true;
  let i = currentIndex;
  const next = () => {
    if (!speakAllMode) return;
    currentIndex = i; renderSentences();
    speakText(SENTENCES[i].en, () => {
      i++;
      if (i < SENTENCES.length) setTimeout(next, 450);
      else speakAllMode = false;
    });
  };
  next();
});

// Timer
let remaining = 60;
let timerId = null;
const timerEl = document.getElementById('timer');
function formatTime(sec) {
  const s = Math.max(0, sec);
  const m = Math.floor(s / 60);
  const r = s % 60;
  return String(m).padStart(2,'0') + ':' + String(r).padStart(2,'0');
}
function renderTimer() {
  timerEl.textContent = formatTime(remaining);
  timerEl.classList.toggle('done', remaining <= 0);
}
function beep() {
  try {
    const ctx = new (window.AudioContext || window.webkitAudioContext)();
    const o = ctx.createOscillator();
    const g = ctx.createGain();
    o.connect(g); g.connect(ctx.destination);
    o.type = 'sine'; o.frequency.value = 880;
    g.gain.setValueAtTime(0.0001, ctx.currentTime);
    g.gain.exponentialRampToValueAtTime(0.15, ctx.currentTime + 0.02);
    g.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime + 0.35);
    o.start(); o.stop(ctx.currentTime + 0.36);
  } catch(e) { console.log(e); }
}
function startTimer() {
  if (timerId) return;
  timerId = setInterval(() => {
    remaining -= 1;
    renderTimer();
    if (remaining <= 0) {
      clearInterval(timerId); timerId = null; remaining = 0; renderTimer(); beep();
    }
  }, 1000);
}
function pauseTimer() { if (timerId) { clearInterval(timerId); timerId = null; } }
document.getElementById('startTimerBtn').addEventListener('click', startTimer);
document.getElementById('pauseTimerBtn').addEventListener('click', pauseTimer);
document.getElementById('resetTimerBtn').addEventListener('click', () => { pauseTimer(); remaining = 60; renderTimer(); });
document.getElementById('plus10Btn').addEventListener('click', () => { remaining += 10; renderTimer(); });
document.getElementById('minus10Btn').addEventListener('click', () => { remaining = Math.max(0, remaining - 10); renderTimer(); });
renderTimer();

// Recorder
let mediaRecorder = null;
let recChunks = [];
let recStream = null;
const recStatus = document.getElementById('recStatus');
const startRecBtn = document.getElementById('startRecBtn');
const stopRecBtn = document.getElementById('stopRecBtn');
const clearRecBtn = document.getElementById('clearRecBtn');
const audioPlayer = document.getElementById('audioPlayer');
const downloadWrap = document.getElementById('downloadWrap');

async function startRecording() {
  if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
    recStatus.textContent = 'ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯éŒ²éŸ³ã«æœªå¯¾å¿œã§ã™'; return;
  }
  try {
    recStream = await navigator.mediaDevices.getUserMedia({ audio:true });
    recChunks = [];
    const mimeCandidates = ['audio/webm;codecs=opus','audio/webm','audio/mp4','audio/ogg;codecs=opus'];
    const mimeType = mimeCandidates.find(m => window.MediaRecorder && MediaRecorder.isTypeSupported && MediaRecorder.isTypeSupported(m)) || '';
    mediaRecorder = new MediaRecorder(recStream, mimeType ? { mimeType } : undefined);
    mediaRecorder.ondataavailable = e => { if (e.data && e.data.size) recChunks.push(e.data); };
    mediaRecorder.onstart = () => { recStatus.innerHTML = '<span class="status info">éŒ²éŸ³ä¸­...</span>'; startRecBtn.disabled = true; stopRecBtn.disabled = false; };
    mediaRecorder.onstop = () => {
      const blob = new Blob(recChunks, { type: mediaRecorder.mimeType || 'audio/webm' });
      const url = URL.createObjectURL(blob);
      audioPlayer.src = url; audioPlayer.hidden = false;
      const a = document.createElement('a');
      a.href = url;
      const ext = (blob.type.includes('mp4') ? 'm4a' : blob.type.includes('ogg') ? 'ogg' : 'webm');
      a.download = `speech_practice_${new Date().toISOString().replace(/[:.]/g,'-')}.${ext}`;
      a.textContent = 'éŒ²éŸ³ã‚’ä¿å­˜ï¼ˆãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ï¼‰';
      a.style.display='inline-block'; a.style.marginTop='8px';
      downloadWrap.innerHTML=''; downloadWrap.appendChild(a);
      recStatus.innerHTML = '<span class="status ok">éŒ²éŸ³å®Œäº†</span>';
      startRecBtn.disabled = false; stopRecBtn.disabled = true;
      if (recStream) recStream.getTracks().forEach(t=>t.stop());
      recStream = null;
    };
    mediaRecorder.start();
  } catch(err) {
    console.error(err);
    recStatus.innerHTML = '<span class="status bad">éŒ²éŸ³é–‹å§‹ã§ãã¾ã›ã‚“ã§ã—ãŸï¼ˆãƒã‚¤ã‚¯è¨±å¯ãŒå¿…è¦ï¼‰</span>';
  }
}
function stopRecording() { if (mediaRecorder && mediaRecorder.state !== 'inactive') mediaRecorder.stop(); }
startRecBtn.addEventListener('click', startRecording);
stopRecBtn.addEventListener('click', stopRecording);
clearRecBtn.addEventListener('click', () => {
  audioPlayer.hidden = true; audioPlayer.removeAttribute('src'); downloadWrap.innerHTML=''; recStatus.textContent='éŒ²éŸ³å¾…æ©Ÿä¸­';
});

// Speech recognition (transcription)
const transcriptEl = document.getElementById('transcript');
const transStatus = document.getElementById('transStatus');
const startTransBtn = document.getElementById('startTransBtn');
const stopTransBtn = document.getElementById('stopTransBtn');
let recognition = null;
let recognizing = false;

function setupRecognition() {
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  if (!SR) {
    transStatus.innerHTML = '<span class="status bad">ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã§ã¯æ–‡å­—èµ·ã“ã—APIãŒä½¿ãˆã¾ã›ã‚“ï¼ˆChromeç³»ã§è©¦ã™ã¨å‹•ãã“ã¨ãŒã‚ã‚Šã¾ã™ï¼‰</span>';
    startTransBtn.disabled = true;
    return;
  }
  recognition = new SR();
  recognition.lang = 'en-US';
  recognition.continuous = true;
  recognition.interimResults = true;
  recognition.onstart = () => { recognizing = true; transStatus.innerHTML = '<span class="status info">æ–‡å­—èµ·ã“ã—ä¸­...</span>'; startTransBtn.disabled = true; stopTransBtn.disabled = false; };
  recognition.onend = () => { recognizing = false; transStatus.innerHTML = '<span class="status ok">æ–‡å­—èµ·ã“ã—åœæ­¢</span>'; startTransBtn.disabled = false; stopTransBtn.disabled = true; };
  recognition.onerror = (e) => { transStatus.innerHTML = `<span class="status bad">ã‚¨ãƒ©ãƒ¼: ${e.error}</span>`; };
  recognition.onresult = (event) => {
    let interim = '';
    let finals = [];
    for (let i = event.resultIndex; i < event.results.length; i++) {
      const res = event.results[i];
      const txt = res[0].transcript;
      if (res.isFinal) finals.push(txt.trim()); else interim += txt;
    }
    // keep interim preview at the end in brackets
    const base = transcriptEl.dataset.finalText || '';
    const finalAppend = finals.length ? (base ? base + '
' : '') + finals.join('
') : base;
    transcriptEl.dataset.finalText = finalAppend;
    transcriptEl.value = finalAppend + (interim ? `
[...${interim.trim()}]` : '');
  };
}
setupRecognition();
startTransBtn.addEventListener('click', () => { try { recognition && recognition.start(); } catch(e) { console.log(e); } });
stopTransBtn.addEventListener('click', () => { try { recognition && recognition.stop(); } catch(e) { console.log(e); } });
document.getElementById('copyTransBtn').addEventListener('click', async () => {
  try { await navigator.clipboard.writeText(transcriptEl.value); transStatus.innerHTML = '<span class="status ok">ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ</span>'; }
  catch(e) { transStatus.innerHTML = '<span class="status bad">ã‚³ãƒ”ãƒ¼å¤±æ•—ï¼ˆé•·æŠ¼ã—ã‚³ãƒ”ãƒ¼ã‚’ä½¿ã£ã¦ã­ï¼‰</span>'; }
});
document.getElementById('clearTransBtn').addEventListener('click', () => { transcriptEl.value=''; transcriptEl.dataset.finalText=''; transStatus.textContent='ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ'; });
</script>
</body></html>
